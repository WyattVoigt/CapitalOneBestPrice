<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Search and Selection</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Search for Products</h1>

    <!-- Search Form -->
    <form method="POST">
        <label for="search_input">Enter an item name:</label>
        <input type="text" id="search_input" name="search_input" value="{{ search_input }}" required>
        <button type="submit" name="search">Search</button>
        <button type="button" id="clear">Clear List</button>
    </form>

    <!-- Display Top 10 HEB Matches -->
    <div id="heb_section">
        {% if top_heb_matches %}
            <h2>Top 10 HEB Matches</h2>
            <ul id="heb_matches">
                {% for idx, item in enumerate(top_heb_matches) %}
                    <li>
                        <input type="radio" name="selected_heb" value="{{ idx }}" id="heb_{{ idx }}">
                        <label for="heb_{{ idx }}">{{ item['title'] }} - ${{ '%.2f'|format(item['price']) }}</label>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <!-- Display Top 10 Target Matches -->
    <div id="target_section">
        {% if top_target_matches %}
            <h2>Top 10 Target Matches</h2>
            <ul id="target_matches">
                {% for idx, item in enumerate(top_target_matches) %}
                    <li>
                        <input type="radio" name="selected_target" value="{{ idx }}" id="target_{{ idx }}">
                        <label for="target_{{ idx }}">{{ item['title'] }} - ${{ '%.2f'|format(item['price']) }}</label>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <!-- Display Top 10 Walmart Matches -->
    <div id="walmart_section">
        {% if top_walmart_matches %}
            <h2>Top 10 Walmart Matches</h2>
            <ul id="walmart_matches">
                {% for idx, item in enumerate(top_walmart_matches) %}
                    <li>
                        <input type="radio" name="selected_walmart" value="{{ idx }}" id="walmart_{{ idx }}">
                        <label for="walmart_{{ idx }}">{{ item['Title'] }} - ${{ '%.2f'|format(item['PRICE_CURRENT']) }}</label>
                    </li>
                {% endfor %}
            </ul>
            <button id="upload">Add Selected Items</button>
        {% endif %}
    </div>

    <!-- Display Selected Items -->
    <div id="selected_items_section">
        <h2>Your Selected Items</h2>
        <h3>HEB:</h3>
        <ul id="selected_items_heb">
            {% for title, price in selected_items_heb %}
                <li>{{ title }} - ${{ '%.2f'|format(price) }}</li>
            {% endfor %}
        </ul>
        <h3>Target:</h3>
        <ul id="selected_items_target">
            {% for title, price in selected_items_target %}
                <li>{{ title }} - ${{ '%.2f'|format(price) }}</li>
            {% endfor %}
        </ul>
        <h3>Walmart:</h3>
        <ul id="selected_items_walmart">
            {% for title, price in selected_items_walmart %}
                <li>{{ title }} - ${{ '%.2f'|format(price) }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Display Total Costs -->
    <div id="total_costs_section">
        <h2>Total Costs</h2>
        <p>HEB: $<span id="total_cost_heb">{{ total_cost_heb }}</span></p>
        <p>Target: $<span id="total_cost_target">{{ total_cost_target }}</span></p>
        <p>Walmart: $<span id="total_cost_walmart">{{ total_cost_walmart }}</span></p>
    </div>

    <!-- Display Savings -->
    <div id="savings_section">
        <p id="savings_message">You would save an average of ${{ savings }} at {{ cheaper_store }}.</p>
    </div>

    <script>
        $(document).ready(function() {
            // Add selected items and clear search results
            $('#upload').on('click', function(e) {
                e.preventDefault();

                const selectedHeb = $('input[name="selected_heb"]:checked').val();
                const selectedTarget = $('input[name="selected_target"]:checked').val();
                const selectedWalmart = $('input[name="selected_walmart"]:checked').val();
                const topHebMatches = {{ top_heb_matches|tojson|safe }};
                const topTargetMatches = {{ top_target_matches|tojson|safe }};
                const topWalmartMatches = {{ top_walmart_matches|tojson|safe }};

                $.ajax({
                    url: "/add_items",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        selected_heb: selectedHeb,
                        selected_target: selectedTarget,
                        selected_walmart: selectedWalmart,
                        top_heb_matches: topHebMatches,
                        top_target_matches: topTargetMatches,
                        top_walmart_matches: topWalmartMatches
                    }),
                    success: function(response) {
                        // Update Selected Items
                        $('#selected_items_heb').empty();
                        response.selected_items_heb.forEach(function(item) {
                            $('#selected_items_heb').append('<li>' + item[0] + ' - $' + parseFloat(item[1]).toFixed(2) + '</li>');
                        });

                        $('#selected_items_target').empty();
                        response.selected_items_target.forEach(function(item) {
                            $('#selected_items_target').append('<li>' + item[0] + ' - $' + parseFloat(item[1]).toFixed(2) + '</li>');
                        });

                        $('#selected_items_walmart').empty();
                        response.selected_items_walmart.forEach(function(item) {
                            $('#selected_items_walmart').append('<li>' + item[0] + ' - $' + parseFloat(item[1]).toFixed(2) + '</li>');
                        });

                        // Update Total Costs
                        $('#total_cost_heb').text(response.total_cost_heb);
                        $('#total_cost_target').text(response.total_cost_target);
                        $('#total_cost_walmart').text(response.total_cost_walmart);

                        // Update Savings Message
                        $('#savings_message').text('You would save $' + response.savings + ' at ' + response.cheaper_store + '.');

                        // Clear search results
                        $('#heb_section').remove();
                        $('#target_section').remove();
                        $('#walmart_section').remove();
                    }
                });
            });

            // Clear all selected items and totals
            $('#clear').on('click', function(e) {
                e.preventDefault();

                $.ajax({
                    url: "/clear_items",
                    type: "POST",
                    success: function() {
                        // Clear displayed items and reset totals
                        $('#selected_items_heb').empty();
                        $('#selected_items_target').empty();
                        $('#selected_items_walmart').empty();
                        $('#total_cost_heb').text('0.00');
                        $('#total_cost_target').text('0.00');
                        $('#total_cost_walmart').text('0.00');
                        $('#savings_message').text('You would save $0.00 at HEB.');
                    }
                });
            });
        });
    </script>
</body>
</html>
